<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mein spirituelles Profil - Helionis</title>
    <meta name="description" content="Ihr pers√∂nliches spirituelles Dashboard - Verwalten Sie Ihr Helionis-Profil und entdecken Sie Ihre kosmische Signatur">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/sprites.css">
    
    <!-- Fonts -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&display=swap" as="style">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&display=swap" as="style">
    
    <style>
        .profile-header {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.1), rgba(255, 215, 0, 0.1));
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .profile-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--primary);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            position: relative;
        }
        
        .spiritual-level {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .cosmic-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
        }
        
        .danger-zone {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--dark);
            border: 1px solid var(--primary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            fill: transparent;
            stroke: var(--primary);
            stroke-width: 4;
            stroke-linecap: round;
            transition: stroke-dasharray 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Ultrarealistischer WebGL Rauch -->
    <!-- Smoke canvas entfernt -->
    <div class="no-webgl-fallback"></div>
    
    <!-- Mystische Partikel entfernt -->
    
    <!-- Navigation -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <a href="/" class="logo">HELIONIS</a>
            
            <ul class="nav-menu" id="nav-menu">
                <li><a href="index.html" class="nav-link">Start</a></li>
                <li><a href="shop.html" class="nav-link">Shop</a></li>
                <!-- Horoskop-Link entfernt -->
                <li><a href="about.html" class="nav-link">√úber uns</a></li>
                <li><a href="cart.html" class="nav-link cart-icon"><svg class="mystical-sprite" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 5h2l2.5 11h10l2-7H8" fill="none" stroke="currentColor" stroke-width="2"/><circle cx="9.5" cy="19" r="1.5" fill="currentColor"/><circle cx="17.5" cy="19" r="1.5" fill="currentColor"/></svg> <span class="cart-count" id="cart-count">0</span></a></li>
                <li><a href="profile.html" class="nav-link active"><svg class="mystical-sprite" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="8" r="4" fill="currentColor"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6" fill="currentColor"/></svg> <span id="user-status">Profil</span></a></li>
            </ul>
            
            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content" style="padding-top: 140px;">
        <div class="container">
            <!-- Profile Header -->
            <div class="profile-header">
                <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
                    <img id="profile-avatar" src="" alt="Profilbild" class="profile-avatar">
                    <div style="flex: 1; min-width: 200px;">
                        <h1 id="profile-name" class="page-title" style="margin: 0;">Willkommen zur√ºck!</h1>
                        <p id="profile-email" class="page-subtitle" style="margin: 0.5rem 0;"></p>
                        <div class="spiritual-level">‚ú® Spiritueller Entdecker</div>
                        <p style="color: var(--silver); margin-top: 1rem;">
                            Mitglied seit <span id="member-since"></span>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Cosmic Statistics -->
            <div class="card">
                <h2 class="card-title">üåü Ihre kosmische Signatur</h2>
                <div class="cosmic-stats">
                    <div class="stat-card">
                        <svg class="progress-ring" width="80" height="80">
                            <circle class="progress-ring-circle" 
                                    cx="40" cy="40" r="36" 
                                    stroke-dasharray="226 226"
                                    id="profile-progress"></circle>
                        </svg>
                        <h3 style="color: var(--primary); margin: 1rem 0 0.5rem;">Profil</h3>
                        <p style="color: var(--silver); font-size: 0.9rem;" id="profile-completion">75% vollst√§ndig</p>
                    </div>
                    
                    <div class="stat-card">
                        <div style="font-size: 2.5rem; color: var(--primary); margin-bottom: 0.5rem;">üõí</div>
                        <h3 style="color: var(--primary); margin: 0 0 0.5rem;">Bestellungen</h3>
                        <p style="color: var(--silver); font-size: 1.2rem; font-weight: 600;" id="order-count">0</p>
                    </div>
                    
                    <div class="stat-card">
                        <div style="font-size: 2.5rem; color: var(--primary); margin-bottom: 0.5rem;">üîÆ</div>
                        <h3 style="color: var(--primary); margin: 0 0 0.5rem;">Horoskope</h3>
                        <p style="color: var(--silver); font-size: 1.2rem; font-weight: 600;" id="horoscope-count">0</p>
                    </div>
                    
                    <div class="stat-card">
                        <div style="font-size: 2.5rem; color: var(--primary); margin-bottom: 0.5rem;">üíé</div>
                        <h3 style="color: var(--primary); margin: 0 0 0.5rem;">Treuepunkte</h3>
                        <p style="color: var(--silver); font-size: 1.2rem; font-weight: 600;" id="loyalty-points">0</p>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <h2 class="card-title">‚ö° Schnellaktionen</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                    <button class="btn btn-primary" onclick="openEditProfile()" style="padding: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <svg class="mystical-sprite" style="width: 1.2rem; height: 1.2rem;"><use href="#edit"></use></svg>
                        Profil bearbeiten
                    </button>
                    
                    <!-- Horoskop CTA entfernt -->
                        <svg class="mystical-sprite" style="width: 1.2rem; height: 1.2rem;"><use href="#star"></use></svg>
                        Neues Horoskop
                    </a>
                    
                    <a href="shop.html" class="btn btn-secondary" style="padding: 1rem; display: flex; align-items: center; gap: 0.5rem; text-decoration: none;">
                        <svg class="mystical-sprite" style="width: 1.2rem; height: 1.2rem;"><use href="#cart"></use></svg>
                        Zum Shop
                    </a>
                    
                    <button class="btn btn-secondary" onclick="downloadData()" style="padding: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <svg class="mystical-sprite" style="width: 1.2rem; height: 1.2rem;"><use href="#download"></use></svg>
                        Daten exportieren
                    </button>
                </div>
            </div>
            
            <!-- Spiritual Interests -->
            <div class="card">
                <h2 class="card-title">üßø Ihre spirituellen Interessen</h2>
                <div id="interests-display" style="display: flex; flex-wrap: wrap; gap: 1rem;">
                    <!-- Interests will be populated by JavaScript -->
                </div>
                <div style="margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="openEditProfile()">Interessen bearbeiten</button>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="card">
                <h2 class="card-title">üìä Letzte Aktivit√§ten</h2>
                <div id="recent-activity" style="color: var(--silver);">
                    <p>üîÆ Willkommen bei Helionis! Beginnen Sie Ihre spirituelle Reise.</p>
                </div>
            </div>
            
            <!-- Account Settings -->
            <div class="card">
                <h2 class="card-title">‚öôÔ∏è Kontoeinstellungen</h2>
                <div style="display: grid; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="changePassword()">
                        üîê Passwort √§ndern
                    </button>
                    
                    <button class="btn btn-secondary" onclick="exportData()">
                        üì• Meine Daten herunterladen
                    </button>
                    
                    <button class="btn btn-secondary" onclick="toggleNotifications()">
                        üîî Benachrichtigungen verwalten
                    </button>
                    
                    <button class="btn" onclick="signOut()" style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--primary); color: var(--primary);">
                        üö™ Abmelden
                    </button>
                </div>
            </div>
            
            <!-- Danger Zone -->
            <div class="danger-zone">
                <h2 style="color: #ff6b6b; margin-bottom: 1rem;">‚ö†Ô∏è Gefahrenbereich</h2>
                <p style="color: var(--silver); margin-bottom: 1.5rem;">
                    Diese Aktionen sind unwiderruflich. Bitte seien Sie vorsichtig.
                </p>
                <button class="btn-danger" onclick="deleteAccount()">
                    üóëÔ∏è Konto permanent l√∂schen
                </button>
            </div>
        </div>
    </main>
    
    <!-- Edit Profile Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--primary); margin-bottom: 2rem;">‚ú® Profil bearbeiten</h2>
            <form id="profile-form">
                <div class="form-group">
                    <label for="edit-name" class="form-label">Name</label>
                    <input type="text" id="edit-name" name="name" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-phone" class="form-label">Telefon</label>
                    <input type="tel" id="edit-phone" name="phone" class="form-input">
                </div>
                
                <div class="form-group">
                    <label for="edit-birthdate" class="form-label">Geburtsdatum</label>
                    <input type="date" id="edit-birthdate" name="birthdate" class="form-input">
                </div>
                
                <div class="form-group">
                    <label for="edit-street" class="form-label">Stra√üe</label>
                    <input type="text" id="edit-street" name="street" class="form-input">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="edit-zipCode" class="form-label">PLZ</label>
                        <input type="text" id="edit-zipCode" name="zipCode" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="edit-city" class="form-label">Stadt</label>
                        <input type="text" id="edit-city" name="city" class="form-input">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Spirituelle Interessen</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--silver);">
                            <input type="checkbox" name="interests" value="astrologie"> Astrologie
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--silver);">
                            <input type="checkbox" name="interests" value="tarot"> Tarot & Orakel
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--silver);">
                            <input type="checkbox" name="interests" value="meditation"> Meditation
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--silver);">
                            <input type="checkbox" name="interests" value="kristalle"> Kristalle & Steine
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--silver);">
                            <input type="checkbox" name="interests" value="amulette"> Amulette & Talismane
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--silver);">
                            <input type="checkbox" name="interests" value="pyramiden"> Energiepyramiden
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary" id="save-profile-btn">üíæ Speichern</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">‚ùå Abbrechen</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Account Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <h2 style="color: #ff6b6b; margin-bottom: 2rem;">‚ö†Ô∏è Konto l√∂schen</h2>
            <p style="color: var(--silver); margin-bottom: 2rem;">
                Sind Sie sicher, dass Sie Ihr Konto permanent l√∂schen m√∂chten? 
                Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.
            </p>
            <p style="color: var(--silver); margin-bottom: 2rem;">
                Alle Ihre Daten, Bestellungen und Horoskope werden unwiderruflich gel√∂scht.
            </p>
            <div style="display: flex; gap: 1rem;">
                <button class="btn-danger" onclick="confirmDeleteAccount()">üóëÔ∏è Ja, Konto l√∂schen</button>
                <button class="btn btn-secondary" onclick="closeDeleteModal()">‚ùå Abbrechen</button>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>Helionis</h3>
                <p style="color: var(--silver); line-height: 1.6;">
                    Ihr vertrauensvoller Partner f√ºr spirituelle Entwicklung 
                    und mystische Weisheit seit √ºber einem Jahrzehnt.
                </p>
            </div>
            
            <div class="footer-section">
                <h3>Shop</h3>
                <a href="shop.html?category=amulette">Amulette</a>
                <a href="shop.html?category=pyramiden">Pyramiden</a>
                <a href="shop.html?category=wuerfel">W√ºrfel</a>
                <a href="shop.html?category=orakel">Orakel</a>
                <!-- Horoskop-Verweis entfernt -->
            </div>
            
            <div class="footer-section">
                <h3>Service</h3>
                <a href="about.html">√úber uns</a>
                <a href="contact.html">Kontakt</a>
                <a href="shipping.html">Versand</a>
                <a href="returns.html">R√ºckgabe</a>
                <a href="faq.html">FAQ</a>
            </div>
            
            <div class="footer-section">
                <h3>Rechtliches</h3>
                <a href="impressum.html">Impressum</a>
                <a href="datenschutz.html">Datenschutz</a>
                <a href="agb.html">AGB</a>
                <a href="widerruf.html">Widerruf</a>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2024 Helionis. Alle Rechte vorbehalten. | Designed with <svg class="mystical-sprite sparkle-accent"><use href="#sparkle"></use></svg> for spiritual souls</p>
        </div>
    </footer>
    
    <!-- Scripts -->
    <script type="module">
        import { getCurrentUser, getUserProfile, saveUserProfile, onAuthStateChange, signOutUser, auth, database } from './assets/js/firebase-config.js';
        import { deleteUser } from 'firebase/auth';
        import { ref, remove } from 'firebase/database';
        
        let currentUserData = null;
        
        // Check authentication and load profile
        onAuthStateChange(async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const profile = await getUserProfile(user.uid);
                currentUserData = { ...profile, uid: user.uid };
                populateProfile(user, profile);
                updateProfileCompletion(profile);
                updateInterestsDisplay(profile?.interests || []);
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        });
        
        // Populate profile information
                function populateProfile(user, profile) {
                        const avatar = document.getElementById('profile-avatar');
                        avatar.src = user.photoURL || 'assets/images/default-avatar.svg';

                        const fullName = user.displayName || profile?.name || 'Spiritueller Reisender';
                        document.getElementById('profile-name').textContent = fullName;
                        document.getElementById('profile-email').textContent = user.email || profile?.email || '';

                        // Mitglied seit (Fallback: metadata.creationTime falls verf√ºgbar)
                        let createdISO = profile?.createdAt || user.metadata?.creationTime;
                        if(createdISO){
                            try { const d = new Date(createdISO); document.getElementById('member-since').textContent = d.toLocaleDateString('de-DE'); } catch(_){ }
                        }

                        // Adresse aus Profil oder Google (photoURL + name, Google liefert keine Adresse direkt -> Platzhalter anlegen)
                        if(!profile?.address){
                            profile = profile || {}; profile.address = { street:'', city:'', zipCode:'', country:'Deutschland' };
                        }

                        // Formularfelder (falls Modal bereits ge√∂ffnet war)
                        if(currentUserData){
                            const f = (id,val)=>{ const el=document.getElementById(id); if(el && !el.value) el.value = val||''; };
                            f('edit-name', fullName);
                            f('edit-street', profile.address.street);
                            f('edit-city', profile.address.city);
                            f('edit-zipCode', profile.address.zipCode);
                        }

                        document.getElementById('order-count').textContent = profile?.orderCount || 0;
                        document.getElementById('horoscope-count').textContent = profile?.horoscopeCount || 0;
                        document.getElementById('loyalty-points').textContent = profile?.loyaltyPoints || 0;
                }
        
        // Update profile completion progress
        function updateProfileCompletion(profile) {
            const fields = ['name', 'phone', 'birthdate', 'address.street', 'address.city', 'address.zipCode'];
            let completed = 0;
            
            fields.forEach(field => {
                const value = field.includes('.') ? 
                    profile?.[field.split('.')[0]]?.[field.split('.')[1]] : 
                    profile?.[field];
                if (value) completed++;
            });
            
            const percentage = Math.round((completed / fields.length) * 100);
            const circumference = 2 * Math.PI * 36;
            const strokeDasharray = `${(percentage / 100) * circumference} ${circumference}`;
            
            document.getElementById('profile-progress').style.strokeDasharray = strokeDasharray;
            document.getElementById('profile-completion').textContent = `${percentage}% vollst√§ndig`;
        }
        
        // Update interests display
        function updateInterestsDisplay(interests) {
            const container = document.getElementById('interests-display');
            const interestLabels = {
                astrologie: 'üåü Astrologie',
                tarot: 'üîÆ Tarot & Orakel',
                meditation: 'üßò Meditation',
                kristalle: 'üíé Kristalle & Steine',
                amulette: 'üßø Amulette & Talismane',
                pyramiden: 'üî∫ Energiepyramiden'
            };
            
            if (interests.length === 0) {
                container.innerHTML = '<p style="color: var(--silver);">Keine Interessen ausgew√§hlt</p>';
                return;
            }
            
            container.innerHTML = interests.map(interest => 
                `<span style="background: rgba(255, 215, 0, 0.1); color: var(--primary); padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid var(--primary);">
                    ${interestLabels[interest] || interest}
                </span>`
            ).join('');
        }
        
        // Modal functions
        window.openEditProfile = function() {
            const modal = document.getElementById('edit-modal');
            modal.style.display = 'block';
            
            if (currentUserData) {
                document.getElementById('edit-name').value = currentUserData.name || '';
                document.getElementById('edit-phone').value = currentUserData.phone || '';
                document.getElementById('edit-birthdate').value = currentUserData.birthdate || '';
                document.getElementById('edit-street').value = currentUserData.address?.street || '';
                document.getElementById('edit-zipCode').value = currentUserData.address?.zipCode || '';
                document.getElementById('edit-city').value = currentUserData.address?.city || '';
                
                // Set interests
                if (currentUserData.interests) {
                    currentUserData.interests.forEach(interest => {
                        const checkbox = document.querySelector(`input[name="interests"][value="${interest}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            }
        }
        
        window.closeEditModal = function() {
            document.getElementById('edit-modal').style.display = 'none';
        }
        
        window.deleteAccount = function() {
            document.getElementById('delete-modal').style.display = 'block';
        }
        
        window.closeDeleteModal = function() {
            document.getElementById('delete-modal').style.display = 'none';
        }
        
        window.confirmDeleteAccount = async function() {
            const user = getCurrentUser();
            if (!user) return;
            
            try {
                // Delete user data from database
                await remove(ref(database, 'users/' + user.uid));
                
                // Delete user authentication account
                await deleteUser(user);
                
                alert('Ihr Konto wurde erfolgreich gel√∂scht.');
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error deleting account:', error);
                alert('Fehler beim L√∂schen des Kontos. Bitte versuchen Sie es erneut.');
            }
        }
        
        window.signOut = async function() {
            try {
                await signOutUser();
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }
        
        window.downloadData = function() {
            if (!currentUserData) return;
            
            const dataStr = JSON.stringify(currentUserData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'helionis-profile-data.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        window.changePassword = function() {
            alert('Passwort-√Ñnderung √ºber Google-Konto verwalten.');
            window.open('https://myaccount.google.com/security', '_blank');
        }
        
        window.toggleNotifications = function() {
            alert('Benachrichtigungseinstellungen werden in K√ºrze verf√ºgbar sein.');
        }
        
        // Handle profile form submission
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = getCurrentUser();
            if (!user) return;
            
            try {
                const saveBtn = document.getElementById('save-profile-btn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'üíæ Speichert...';
                
                const formData = new FormData(e.target);
                const interests = Array.from(document.querySelectorAll('input[name="interests"]:checked')).map(cb => cb.value);
                
                const profileData = {
                    ...currentUserData,
                    name: formData.get('name'),
                    phone: formData.get('phone'),
                    birthdate: formData.get('birthdate'),
                    address: {
                        street: formData.get('street'),
                        zipCode: formData.get('zipCode'),
                        city: formData.get('city'),
                        country: currentUserData.address?.country || 'Deutschland'
                    },
                    interests: interests
                };
                
                await saveUserProfile(user.uid, profileData);
                currentUserData = profileData;
                
                populateProfile(user, profileData);
                updateProfileCompletion(profileData);
                updateInterestsDisplay(interests);
                
                closeEditModal();
                
                // Show success message
                const successMsg = document.createElement('div');
                successMsg.innerHTML = '‚úÖ Profil erfolgreich aktualisiert!';
                successMsg.style.cssText = 'position: fixed; top: 100px; right: 20px; background: var(--primary); color: var(--dark); padding: 1rem 2rem; border-radius: 8px; z-index: 1001; animation: slideIn 0.3s ease;';
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    document.body.removeChild(successMsg);
                }, 3000);
                
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Fehler beim Speichern des Profils.');
            } finally {
                const saveBtn = document.getElementById('save-profile-btn');
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Speichern';
            }
        });
        
        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
    </script>
    <script src="assets/js/sprites.js"></script>
    <script src="assets/js/cart.js"></script>
    <script src="assets/js/main.js"></script>
    <script type="module" src="assets/js/auth-state.js"></script>
</body>
</html>